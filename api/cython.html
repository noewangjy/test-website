<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="shortcut icon" href="/icons/icon-192x192.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=5.0, shrink-to-fit=no, viewport-fit=cover"/><meta name="theme-color" content="#09a3d5"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png"/><title>Cython Architecture Â· spaCy API Documentation</title><meta name="description" content="spaCy is a free open-source library for Natural Language Processing in Python. It features NER, POS tagging, dependency parsing, word vectors and more."/><meta property="og:title" content="Cython Architecture Â· spaCy API Documentation"/><meta property="og:description" content="spaCy is a free open-source library for Natural Language Processing in Python. It features NER, POS tagging, dependency parsing, word vectors and more."/><meta property="og:type" content="website"/><meta property="og:site_name" content="Cython Architecture"/><meta property="og:image" content="[object Object]"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="[object Object]"/><meta name="twitter:creator" content="@spacy_io"/><meta name="twitter:site" content="@spacy_io"/><meta name="twitter:title" content="Cython Architecture Â· spaCy API Documentation"/><meta name="twitter:description" content="spaCy is a free open-source library for Natural Language Processing in Python. It features NER, POS tagging, dependency parsing, word vectors and more."/><meta name="docsearch:language" content="en"/><meta name="next-head-count" content="24"/><link rel="preload" href="/_next/static/css/8f0b94edbc18d62d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8f0b94edbc18d62d.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e6995e0e8addcf99.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e6995e0e8addcf99.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script defer="" src="/_next/static/chunks/262.c647d33d06232ef6.js"></script><script defer="" src="/_next/static/chunks/728.cf6ba0da2700fa1b.js"></script><script src="/_next/static/chunks/webpack-8161fc2bb14cec39.js" defer=""></script><script src="/_next/static/chunks/framework-3b5a00d5d7e8d93b.js" defer=""></script><script src="/_next/static/chunks/main-a0f603ce323043fd.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ee1fab0e25bb912e.js" defer=""></script><script src="/_next/static/chunks/94-57434c8b7a6c3878.js" defer=""></script><script src="/_next/static/chunks/128-76b45627a109219b.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...listPathPage%5D-45eea57fe8c2902c.js" defer=""></script><script src="/_next/static/2lY2cUyEfZosk4VLgkHb2/_buildManifest.js" defer=""></script><script src="/_next/static/2lY2cUyEfZosk4VLgkHb2/_ssgManifest.js" defer=""></script></head><body class="theme-blue"><div id="__next"><div class="theme-green"><nav class="navigation_root__yPL8O"><span class="navigation_has-alert__s0Drf"><a class="link_root__1Me7D link_no-link-layout__RPvod" aria-label="spaCy" href="/"><h1 class="navigation_title__pm49s">spaCy</h1></a> <span class="navigation_alert__ZOXon"><a class="link_root__1Me7D link_no-link-layout__RPvod" href="/usage/v3-5"><strong>ðŸ’¥ Out now:</strong> spaCy v3.5</a></span></span><div class="navigation_menu__ZMJxN"><select class="dropdown_root__3uiQq navigation_dropdown__4j4pI"><option value="title" disabled="">Menu</option><option value="/usage">Usage</option><option value="/models">Models</option><option value="/api" selected="">API</option><option value="/universe">Universe</option></select><ul class="navigation_list__DCzqi"><li class="navigation_item__ln1O1"><a class="link_root__1Me7D link_no-link-layout__RPvod" href="/usage">Usage</a></li><li class="navigation_item__ln1O1"><a class="link_root__1Me7D link_no-link-layout__RPvod" href="/models">Models</a></li><li class="navigation_item__ln1O1 navigation_is-active__RjVJG"><a class="link_root__1Me7D link_no-link-layout__RPvod" tabindex="-1" href="/api">API</a></li><li class="navigation_item__ln1O1"><a class="link_root__1Me7D link_no-link-layout__RPvod" href="/universe">Universe</a></li><li class="navigation_item__ln1O1 navigation_github__MpFNv"><span><a href="https://github.com/explosion/spaCy" data-size="large" data-show-count="true" aria-label="Star spaCy on GitHub"></a></span></li></ul><div class="navigation_search__BKZCn"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div><progress class="progress_root__9huWN" value="0" max="100"></progress></nav><menu class="sidebar sidebar_root__s2No7"><h1 hidden="" aria-hidden="true" class="h0 sidebar_active-heading___dkf9">Cython</h1><div class="sidebar_dropdown__vyqjz"><select class="dropdown_root__3uiQq sidebar_dropdown-select__Nwbq9"><option disabled="">Select page...</option><option value="/api">Overview<!-- --> â€º <!-- -->Library Architecture</option><option value="/api/architectures">Overview<!-- --> â€º <!-- -->Model Architectures</option><option value="/api/data-formats">Overview<!-- --> â€º <!-- -->Data Formats</option><option value="/api/cli">Overview<!-- --> â€º <!-- -->Command Line</option><option value="/api/top-level">Overview<!-- --> â€º <!-- -->Functions</option><option value="/api/doc">Containers<!-- --> â€º <!-- -->Doc</option><option value="/api/docbin">Containers<!-- --> â€º <!-- -->DocBin</option><option value="/api/example">Containers<!-- --> â€º <!-- -->Example</option><option value="/api/language">Containers<!-- --> â€º <!-- -->Language</option><option value="/api/lexeme">Containers<!-- --> â€º <!-- -->Lexeme</option><option value="/api/span">Containers<!-- --> â€º <!-- -->Span</option><option value="/api/spangroup">Containers<!-- --> â€º <!-- -->SpanGroup</option><option value="/api/token">Containers<!-- --> â€º <!-- -->Token</option><option value="/api/attributeruler">Pipeline<!-- --> â€º <!-- -->AttributeRuler</option><option value="/api/coref">Pipeline<!-- --> â€º <!-- -->CoreferenceResolver</option><option value="/api/dependencyparser">Pipeline<!-- --> â€º <!-- -->DependencyParser</option><option value="/api/edittreelemmatizer">Pipeline<!-- --> â€º <!-- -->EditTreeLemmatizer</option><option value="/api/entitylinker">Pipeline<!-- --> â€º <!-- -->EntityLinker</option><option value="/api/entityrecognizer">Pipeline<!-- --> â€º <!-- -->EntityRecognizer</option><option value="/api/entityruler">Pipeline<!-- --> â€º <!-- -->EntityRuler</option><option value="/api/lemmatizer">Pipeline<!-- --> â€º <!-- -->Lemmatizer</option><option value="/api/morphologizer">Pipeline<!-- --> â€º <!-- -->Morphologizer</option><option value="/api/sentencerecognizer">Pipeline<!-- --> â€º <!-- -->SentenceRecognizer</option><option value="/api/sentencizer">Pipeline<!-- --> â€º <!-- -->Sentencizer</option><option value="/api/spancategorizer">Pipeline<!-- --> â€º <!-- -->SpanCategorizer</option><option value="/api/span-resolver">Pipeline<!-- --> â€º <!-- -->SpanResolver</option><option value="/api/spanruler">Pipeline<!-- --> â€º <!-- -->SpanRuler</option><option value="/api/tagger">Pipeline<!-- --> â€º <!-- -->Tagger</option><option value="/api/textcategorizer">Pipeline<!-- --> â€º <!-- -->TextCategorizer</option><option value="/api/tok2vec">Pipeline<!-- --> â€º <!-- -->Tok2Vec</option><option value="/api/tokenizer">Pipeline<!-- --> â€º <!-- -->Tokenizer</option><option value="/api/pipe">Pipeline<!-- --> â€º <!-- -->TrainablePipe</option><option value="/api/transformer">Pipeline<!-- --> â€º <!-- -->Transformer</option><option value="/api/pipeline-functions">Pipeline<!-- --> â€º <!-- -->Other Functions</option><option value="/api/dependencymatcher">Matchers<!-- --> â€º <!-- -->DependencyMatcher</option><option value="/api/matcher">Matchers<!-- --> â€º <!-- -->Matcher</option><option value="/api/phrasematcher">Matchers<!-- --> â€º <!-- -->PhraseMatcher</option><option value="/api/attributes">Other<!-- --> â€º <!-- -->Attributes</option><option value="/api/corpus">Other<!-- --> â€º <!-- -->Corpus</option><option value="/api/inmemorylookupkb">Other<!-- --> â€º <!-- -->InMemoryLookupKB</option><option value="/api/kb">Other<!-- --> â€º <!-- -->KnowledgeBase</option><option value="/api/lookups">Other<!-- --> â€º <!-- -->Lookups</option><option value="/api/morphology#morphanalysis">Other<!-- --> â€º <!-- -->MorphAnalysis</option><option value="/api/morphology">Other<!-- --> â€º <!-- -->Morphology</option><option value="/api/scorer">Other<!-- --> â€º <!-- -->Scorer</option><option value="/api/stringstore">Other<!-- --> â€º <!-- -->StringStore</option><option value="/api/vectors">Other<!-- --> â€º <!-- -->Vectors</option><option value="/api/vocab">Other<!-- --> â€º <!-- -->Vocab</option><option value="/api/cython" selected="">Cython<!-- --> â€º <!-- -->Architecture</option><option value="/api/cython-classes">Cython<!-- --> â€º <!-- -->Classes</option><option value="/api/cython-structs">Cython<!-- --> â€º <!-- -->Structs</option><option value="/api/legacy">Legacy<!-- --> â€º <!-- -->Legacy functions</option></select></div><ul class="sidebar_section__DArOO"><li class="sidebar_label__V3K28">Overview</li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api">Library Architecture</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/architectures">Model Architectures</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/data-formats">Data Formats</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/cli">Command Line</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/top-level">Functions</a></li></ul><ul class="sidebar_section__DArOO"><li class="sidebar_label__V3K28">Containers</li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/doc">Doc</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/docbin">DocBin</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/example">Example</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/language">Language</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/lexeme">Lexeme</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/span">Span</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/spangroup">SpanGroup</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/token">Token</a></li></ul><ul class="sidebar_section__DArOO"><li class="sidebar_label__V3K28">Pipeline</li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/attributeruler">AttributeRuler</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/coref">CoreferenceResolver</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/dependencyparser">DependencyParser</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/edittreelemmatizer">EditTreeLemmatizer</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/entitylinker">EntityLinker</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/entityrecognizer">EntityRecognizer</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/entityruler">EntityRuler</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/lemmatizer">Lemmatizer</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/morphologizer">Morphologizer</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/sentencerecognizer">SentenceRecognizer</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/sentencizer">Sentencizer</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/spancategorizer">SpanCategorizer</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/span-resolver">SpanResolver</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/spanruler">SpanRuler</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/tagger">Tagger</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/textcategorizer">TextCategorizer</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/tok2vec">Tok2Vec</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/tokenizer">Tokenizer</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/pipe">TrainablePipe</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/transformer">Transformer</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/pipeline-functions">Other Functions</a></li></ul><ul class="sidebar_section__DArOO"><li class="sidebar_label__V3K28">Matchers</li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/dependencymatcher">DependencyMatcher</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/matcher">Matcher</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/phrasematcher">PhraseMatcher</a></li></ul><ul class="sidebar_section__DArOO"><li class="sidebar_label__V3K28">Other</li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/attributes">Attributes</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/corpus">Corpus</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/inmemorylookupkb">InMemoryLookupKB</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/kb">KnowledgeBase</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/lookups">Lookups</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/morphology#morphanalysis">MorphAnalysis</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/morphology">Morphology</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/scorer">Scorer</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/stringstore">StringStore</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/vectors">Vectors</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/vocab">Vocab</a></li></ul><ul class="sidebar_section__DArOO"><li class="sidebar_label__V3K28">Cython</li><li><a class="link_root__1Me7D sidebar_link__sKXFP sidebar_is-active__yVTtL is-active" href="/api/cython">Architecture</a><ul class="sidebar_crumbs__NhM2y"><li class="sidebar_crumb__tiiDl sidebar_crumb-active__zq8BI"><a href="#overview">Overview</a></li><li class="sidebar_crumb__tiiDl"><a href="#conventions">Conventions</a></li></ul></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/cython-classes">Classes</a></li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/cython-structs">Structs</a></li></ul><ul class="sidebar_section__DArOO"><li class="sidebar_label__V3K28">Legacy</li><li><a class="link_root__1Me7D sidebar_link__sKXFP" href="/api/legacy">Legacy functions</a></li></ul></menu><main class="main_root__7f6Tj main_with-sidebar__uH1df main_with-asides__ikQT6"><article class="main_content__8zFCH"><header class="title_root__pS2WQ"><h1 id="_title" class="typography_heading__D82WZ typography_h1__b7dt9 title_h1__l3CW1"><span class="heading-text">Cython Architecture<!-- --> </span></h1></header><section id="section-overview" class="section_root__k1hUl"><aside class="aside_root__667WA"><div class="aside_content__ZN6qm" role="complementary"><div class="aside_text__LFH_Q">
<h4 class="typography_heading__D82WZ typography_h4__CDRaM"><span class="heading-text">Whatâ€™s Cython?<!-- --> </span></h4>
<p><a class="link_root__1Me7D" rel="noopener nofollow noreferrer" target="_blank" href="http://cython.org/">Cython</a> is a language for writing C extensions for
Python. Most Python code is also valid Cython, but you can add type
declarations to get efficient memory-managed code just like C or C++.</p>
</div></div></aside><p>This section documents spaCyâ€™s C-level data structures and interfaces, intended
for use from Cython. Some of the attributes are primarily for internal use, and
all C-level functions and methods are designed for speed over safety â€“ if you
make a mistake and access an array out-of-bounds, the program may crash
abruptly.</p><p>With Cython there are four ways of declaring complex data types. Unfortunately
we use all four in different places, as they all have different utility:</p><table class="table_root__ZlA_w"><thead><tr class="table_tr__K_tkF"><th class="table_th__QJ9F8">Declaration</th><th class="table_th__QJ9F8">Description</th><th class="table_th__QJ9F8">Example</th></tr></thead><tbody><tr class="table_tr__K_tkF"><td class="table_td__rmpJx"><code class="code_inline-code__Bq7ot">class</code></td><td class="table_td__rmpJx">A normal Python class.</td><td class="table_td__rmpJx"><a class="link_root__1Me7D link_nowrap__H7Oxl link_with-icon__NAVDA" href="/api/language"><code class="code_inline-code__Bq7ot">Language</code></a></td></tr><tr class="table_tr__K_tkF"><td class="table_td__rmpJx"><code class="code_inline-code__Bq7ot">cdef class</code></td><td class="table_td__rmpJx">A Python extension type. Differs from a normal Python class in that its attributes can be defined on the underlying struct. Can have C-level objects as attributes (notably structs and pointers), and can have methods which have C-level objects as arguments or return types.</td><td class="table_td__rmpJx"><a class="link_root__1Me7D link_nowrap__H7Oxl link_with-icon__NAVDA" href="/api/cython-classes#lexeme"><code class="code_inline-code__Bq7ot">Lexeme</code></a></td></tr><tr class="table_tr__K_tkF"><td class="table_td__rmpJx"><code class="code_inline-code__Bq7ot">cdef struct</code></td><td class="table_td__rmpJx">A struct is just a collection of variables, sort of like a named tuple, except the memory is contiguous. Structs canâ€™t have methods, only attributes.</td><td class="table_td__rmpJx"><a class="link_root__1Me7D link_nowrap__H7Oxl link_with-icon__NAVDA" href="/api/cython-structs#lexemec"><code class="code_inline-code__Bq7ot">LexemeC</code></a></td></tr><tr class="table_tr__K_tkF"><td class="table_td__rmpJx"><code class="code_inline-code__Bq7ot">cdef cppclass</code></td><td class="table_td__rmpJx">A C++ class. Like a struct, this can be allocated on the stack, but can have methods, a constructor and a destructor. Differs from <code class="code_inline-code__Bq7ot">cdef class</code> in that it can be created and destroyed without acquiring the Python global interpreter lock. This style is the most obscure.</td><td class="table_td__rmpJx"><a class="link_root__1Me7D link_nowrap__H7Oxl link_with-icon__NAVDA" rel="noopener nofollow noreferrer" target="_blank" href="https://github.com/explosion/spaCy/tree/master/spacy/pipeline/_parser_internals/_state.pxd"><code class="code_inline-code__Bq7ot">StateC</code></a></td></tr></tbody></table><p>The most important classes in spaCy are defined as <code class="code_inline-code__Bq7ot">cdef class</code> objects. The
underlying data for these objects is usually gathered into a struct, which is
usually named <code class="code_inline-code__Bq7ot">c</code>. For instance, the <a class="link_root__1Me7D link_nowrap__H7Oxl link_with-icon__NAVDA" href="/api/cython-classses#lexeme"><code class="code_inline-code__Bq7ot">Lexeme</code></a>
class holds a <a class="link_root__1Me7D link_nowrap__H7Oxl link_with-icon__NAVDA" href="/api/cython-structs#lexemec"><code class="code_inline-code__Bq7ot">LexemeC</code></a> struct, at <code class="code_inline-code__Bq7ot">Lexeme.c</code>.
This lets you shed the Python container, and pass a pointer to the underlying
data into C-level functions.</p></section>
<section id="section-conventions" class="section_root__k1hUl"><h2 id="conventions" class="typography_heading__D82WZ typography_h2__hzV3h"><a href="#conventions" class="heading-text typography_permalink__UiIRy">Conventions <!-- --> </a></h2><p>spaCyâ€™s core data structures are implemented as <a class="link_root__1Me7D" rel="noopener nofollow noreferrer" target="_blank" href="http://cython.org/">Cython</a>
<code class="code_inline-code__Bq7ot">cdef</code> classes. Memory is managed through the
<a class="link_root__1Me7D link_nowrap__H7Oxl link_with-icon__NAVDA" rel="noopener nofollow noreferrer" target="_blank" href="https://github.com/explosion/cymem"><code class="code_inline-code__Bq7ot">cymem</code></a> <code class="code_inline-code__Bq7ot">cymem.Pool</code> class, which allows
you to allocate memory which will be freed when the <code class="code_inline-code__Bq7ot">Pool</code> object is garbage
collected. This means you usually donâ€™t have to worry about freeing memory. You
just have to decide which Python object owns the memory, and make it own the
<code class="code_inline-code__Bq7ot">Pool</code>. When that object goes out of scope, the memory will be freed. You do
have to take care that no pointers outlive the object that owns them â€” but this
is generally quite easy.</p><p>All Cython modules should have the <code class="code_inline-code__Bq7ot"># cython: infer_types=True</code> compiler
directive at the top of the file. This makes the code much cleaner, as it avoids
the need for many type declarations. If possible, you should prefer to declare
your functions <code class="code_inline-code__Bq7ot">nogil</code>, even if you donâ€™t especially care about multi-threading.
The reason is that <code class="code_inline-code__Bq7ot">nogil</code> functions help the Cython compiler reason about your
code quite a lot â€” youâ€™re telling the compiler that no Python dynamics are
possible. This lets many errors be raised, and ensures your function will run at
C speed.</p><p>Cython gives you many choices of sequences: you could have a Python list, a
numpy array, a memory view, a C++ vector, or a pointer. Pointers are preferred,
because they are fastest, have the most explicit semantics, and let the compiler
check your code more strictly. C++ vectors are also great â€” but you should only
use them internally in functions. Itâ€™s less friendly to accept a vector as an
argument, because that asks the user to do much more work. Hereâ€™s how to get a
pointer from a numpy array, memory view or vector:</p><pre class="code_pre__kzg60"><code class="code_code__CILJL language-python language-python"></code></pre><p>Both C arrays and C++ vectors reassure the compiler that no Python operations
are possible on your variable. This is a big advantage: it lets the Cython
compiler raise many more errors for you.</p><p>When getting a pointer from a numpy array or memoryview, take care that the data
is actually stored in C-contiguous order â€” otherwise youâ€™ll get a pointer to
nonsense. The type-declarations in the code above should generate runtime errors
if buffers with incorrect memory layouts are passed in. To iterate over the
array, the following style is preferred:</p><pre class="code_pre__kzg60"><code class="code_code__CILJL language-python language-python"></code></pre><p>If this is confusing, consider that the compiler couldnâ€™t deal with
<code class="code_inline-code__Bq7ot">for item in int_array:</code> â€” thereâ€™s no length attached to a raw pointer, so how
could we figure out where to stop? The length is provided in the slice notation
as a solution to this. Note that we donâ€™t have to declare the type of <code class="code_inline-code__Bq7ot">item</code> in
the code above â€” the compiler can easily infer it. This gives us tidy code that
looks quite like Python, but is exactly as fast as C â€” because weâ€™ve made sure
the compilation to C is trivial.</p><p>Your functions cannot be declared <code class="code_inline-code__Bq7ot">nogil</code> if they need to create Python objects
or call Python functions. This is perfectly okay â€” you shouldnâ€™t torture your
code just to get <code class="code_inline-code__Bq7ot">nogil</code> functions. However, if your function isnâ€™t <code class="code_inline-code__Bq7ot">nogil</code>, you
should compile your module with <code class="code_inline-code__Bq7ot code_wrap__b41os">cython -a --cplus my_module.pyx</code> and open the
resulting <code class="code_inline-code__Bq7ot">my_module.html</code> file in a browser. This will let you see how Cython
is compiling your code. Calls into the Python run-time will be in bright yellow.
This lets you easily see whether Cython is able to correctly type your code, or
whether there are unexpected problems.</p><p>Working in Cython is very rewarding once youâ€™re over the initial learning curve.
As with C and C++, the first way you write something in Cython will often be the
performance-optimal approach. In contrast, Python optimization generally
requires a lot of experimentation. Is it faster to have an <code class="code_inline-code__Bq7ot">if item in my_dict</code>
check, or to use <code class="code_inline-code__Bq7ot">.get()</code>? What about <code class="code_inline-code__Bq7ot">try</code>/<code class="code_inline-code__Bq7ot">except</code>? Does this numpy operation
create a copy? Thereâ€™s no way to guess the answers to these questions, and
youâ€™ll usually be dissatisfied with your results â€” so thereâ€™s no way to know
when to stop this process. In the worst case, youâ€™ll make a mess that invites
the next reader to try their luck too. This is like one of those
<a class="link_root__1Me7D" rel="noopener nofollow noreferrer" target="_blank" href="http://www.wemjournal.org/article/S1080-6032%2809%2970088-2/abstract">volcanic gas-traps</a>,
where the rescuers keep passing out from low oxygen, causing another rescuer to
follow â€” only to succumb themselves. In short, just say no to optimizing your
Python. If itâ€™s not fast enough the first time, just switch to Cython.</p><aside class="infobox_root__yNIMg"><h4 class="infobox_title__uDT7C"><span><span class="infobox_emoji__6_YUY" aria-hidden="true">ðŸ“–</span>Resources</span></h4><ul class="list_ul__fe_HF">
<li class="list_li__sfx_z"><a class="link_root__1Me7D" rel="noopener nofollow noreferrer" target="_blank" href="http://docs.cython.org/en/latest/">Official Cython documentation</a>
(cython.org)</li>
<li class="list_li__sfx_z"><a class="link_root__1Me7D" href="https://explosion.ai/blog/writing-c-in-cython">Writing C in Cython</a>
(explosion.ai)</li>
<li class="list_li__sfx_z"><a class="link_root__1Me7D" href="https://explosion.ai/blog/multithreading-with-cython">Multi-threading spaCyâ€™s parser and named entity recognizer</a>
(explosion.ai)</li>
</ul></aside></section><div class="grid_root__EfDZl grid_spacing__fhBCv grid_half__xoJZs"><div style="margin-top:var(--spacing-lg)"><a class="link_root__1Me7D button_root__jwipc button_secondary__ukZAk" rel="noopener nofollow noreferrer" target="_blank" href="https://github.com/explosion/spaCy/tree/master/website/docs/api/cython.mdx">Suggest edits</a></div></div></article><div class="main_asides__RITE5" style="background-image:url(/_next/static/media/pattern_green.92f07e1d.png"></div><footer class="footer_root__zlkjP"><div class="grid_root__EfDZl footer_content__LaE1F grid_narrow__x_6xS grid_spacing__fhBCv grid_third__edHuB"><section><ul class="footer_column__DPe22"><li class="footer_label__xK7_s">spaCy</li><li><a class="link_root__1Me7D link_no-link-layout__RPvod" href="/usage">Usage</a></li><li><a class="link_root__1Me7D link_no-link-layout__RPvod" href="/models">Models</a></li><li><a class="link_root__1Me7D link_no-link-layout__RPvod" href="/api">API Reference</a></li><li><a class="link_root__1Me7D link_no-link-layout__RPvod" href="https://course.spacy.io">Online Course</a></li><li><a class="link_root__1Me7D link_no-link-layout__RPvod" href="https://explosion.ai/custom-solutions">Custom Solutions</a></li></ul></section><section><ul class="footer_column__DPe22"><li class="footer_label__xK7_s">Community</li><li><a class="link_root__1Me7D link_no-link-layout__RPvod" href="/universe">Universe</a></li><li><a class="link_root__1Me7D link_no-link-layout__RPvod" rel="noopener nofollow noreferrer" target="_blank" href="https://github.com/explosion/spaCy/discussions">GitHub Discussions</a></li><li><a class="link_root__1Me7D link_no-link-layout__RPvod" rel="noopener nofollow noreferrer" target="_blank" href="https://github.com/explosion/spaCy/issues">Issue Tracker</a></li><li><a class="link_root__1Me7D link_no-link-layout__RPvod" rel="noopener nofollow noreferrer" target="_blank" href="http://stackoverflow.com/questions/tagged/spacy">Stack Overflow</a></li></ul></section><section><ul class="footer_column__DPe22"><li class="footer_label__xK7_s">Connect</li><li><a class="link_root__1Me7D link_no-link-layout__RPvod" rel="noopener nofollow noreferrer" target="_blank" href="https://twitter.com/spacy_io">Twitter</a></li><li><a class="link_root__1Me7D link_no-link-layout__RPvod" rel="noopener nofollow noreferrer" target="_blank" href="https://github.com/explosion/spaCy">GitHub</a></li><li><a class="link_root__1Me7D link_no-link-layout__RPvod" rel="noopener nofollow noreferrer" target="_blank" href="https://youtube.com/c/ExplosionAI">YouTube</a></li><li><a class="link_root__1Me7D link_no-link-layout__RPvod" href="https://explosion.ai/blog">Blog</a></li></ul></section><section class="footer_full___icln"><ul class="footer_column__DPe22"><li class="footer_label__xK7_s">Stay in the loop!</li><li>Receive updates about new releases, tutorials and more.</li><li><form id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" action="//spacy.us12.list-manage.com/subscribe/post?u=83b0498b1e7fa3c91ce68c3f1&amp;amp;id=ecc82e0493" method="post" target="_blank" novalidate=""><div style="position:absolute;left:-5000px" aria-hidden="true"><input type="text" name="b_83b0498b1e7fa3c91ce68c3f1_ecc82e0493" tabindex="-1" value=""/></div><div class="newsletter_root__uh6MU"><input class="newsletter_input___SMSB" id="mce-EMAIL" type="email" name="EMAIL" placeholder="Your email" aria-label="Your email"/><button class="newsletter_button__gKW8E" id="mc-embedded-subscribe" type="submit" name="subscribe">Sign up</button></div></form></li></ul></section></div><div class="footer_content__LaE1F footer_copy__rbjvc"><span>Â© 2016-<!-- -->2023<!-- --> <a class="link_root__1Me7D link_no-link-layout__RPvod" href="https://explosion.ai">Explosion</a></span><a class="link_root__1Me7D footer_logo__BthsJ link_no-link-layout__RPvod" aria-label="Explosion" href="https://explosion.ai"></a><a class="link_root__1Me7D link_no-link-layout__RPvod" href="https://explosion.ai/legal">Legal / Imprint</a></div></footer></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"title":"Cython Architecture","next":null,"menu":[["Overview","overview"],["Conventions","conventions"]],"slug":"/api/cython","mdx":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    section: \"section\",\n    h2: \"h2\",\n    blockquote: \"blockquote\",\n    h4: \"h4\",\n    p: \"p\",\n    a: \"a\",\n    table: \"table\",\n    thead: \"thead\",\n    tr: \"tr\",\n    th: \"th\",\n    tbody: \"tbody\",\n    td: \"td\",\n    pre: \"pre\",\n    code: \"code\",\n    ul: \"ul\",\n    li: \"li\"\n  }, _provideComponents(), props.components), {InlineCode, Infobox} = _components;\n  if (!Infobox) _missingMdxReference(\"Infobox\", true);\n  if (!InlineCode) _missingMdxReference(\"InlineCode\", true);\n  return _jsxs(_Fragment, {\n    children: [_jsxs(_components.section, {\n      id: \"section-overview\",\n      children: [_jsx(_components.h2, {\n        id: \"overview\",\n        hidden: \"true\",\n        children: \"Overview \"\n      }), _jsxs(_components.blockquote, {\n        children: [\"\\n\", _jsx(_components.h4, {\n          children: \"Whatâ€™s Cython?\"\n        }), \"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.a, {\n            href: \"http://cython.org/\",\n            children: \"Cython\"\n          }), \" is a language for writing C extensions for\\nPython. Most Python code is also valid Cython, but you can add type\\ndeclarations to get efficient memory-managed code just like C or C++.\"]\n        }), \"\\n\"]\n      }), _jsx(_components.p, {\n        children: \"This section documents spaCyâ€™s C-level data structures and interfaces, intended\\nfor use from Cython. Some of the attributes are primarily for internal use, and\\nall C-level functions and methods are designed for speed over safety â€“ if you\\nmake a mistake and access an array out-of-bounds, the program may crash\\nabruptly.\"\n      }), _jsx(_components.p, {\n        children: \"With Cython there are four ways of declaring complex data types. Unfortunately\\nwe use all four in different places, as they all have different utility:\"\n      }), _jsxs(_components.table, {\n        children: [_jsx(_components.thead, {\n          children: _jsxs(_components.tr, {\n            children: [_jsx(_components.th, {\n              children: \"Declaration\"\n            }), _jsx(_components.th, {\n              children: \"Description\"\n            }), _jsx(_components.th, {\n              children: \"Example\"\n            })]\n          })\n        }), _jsxs(_components.tbody, {\n          children: [_jsxs(_components.tr, {\n            children: [_jsx(_components.td, {\n              children: _jsx(InlineCode, {\n                children: \"class\"\n              })\n            }), _jsx(_components.td, {\n              children: \"A normal Python class.\"\n            }), _jsx(_components.td, {\n              children: _jsx(_components.a, {\n                href: \"/api/language\",\n                children: _jsx(InlineCode, {\n                  children: \"Language\"\n                })\n              })\n            })]\n          }), _jsxs(_components.tr, {\n            children: [_jsx(_components.td, {\n              children: _jsx(InlineCode, {\n                children: \"cdef class\"\n              })\n            }), _jsx(_components.td, {\n              children: \"A Python extension type. Differs from a normal Python class in that its attributes can be defined on the underlying struct. Can have C-level objects as attributes (notably structs and pointers), and can have methods which have C-level objects as arguments or return types.\"\n            }), _jsx(_components.td, {\n              children: _jsx(_components.a, {\n                href: \"/api/cython-classes#lexeme\",\n                children: _jsx(InlineCode, {\n                  children: \"Lexeme\"\n                })\n              })\n            })]\n          }), _jsxs(_components.tr, {\n            children: [_jsx(_components.td, {\n              children: _jsx(InlineCode, {\n                children: \"cdef struct\"\n              })\n            }), _jsx(_components.td, {\n              children: \"A struct is just a collection of variables, sort of like a named tuple, except the memory is contiguous. Structs canâ€™t have methods, only attributes.\"\n            }), _jsx(_components.td, {\n              children: _jsx(_components.a, {\n                href: \"/api/cython-structs#lexemec\",\n                children: _jsx(InlineCode, {\n                  children: \"LexemeC\"\n                })\n              })\n            })]\n          }), _jsxs(_components.tr, {\n            children: [_jsx(_components.td, {\n              children: _jsx(InlineCode, {\n                children: \"cdef cppclass\"\n              })\n            }), _jsxs(_components.td, {\n              children: [\"A C++ class. Like a struct, this can be allocated on the stack, but can have methods, a constructor and a destructor. Differs from \", _jsx(InlineCode, {\n                children: \"cdef class\"\n              }), \" in that it can be created and destroyed without acquiring the Python global interpreter lock. This style is the most obscure.\"]\n            }), _jsx(_components.td, {\n              children: _jsx(_components.a, {\n                href: \"https://github.com/explosion/spaCy/tree/master/spacy/pipeline/_parser_internals/_state.pxd\",\n                children: _jsx(InlineCode, {\n                  children: \"StateC\"\n                })\n              })\n            })]\n          })]\n        })]\n      }), _jsxs(_components.p, {\n        children: [\"The most important classes in spaCy are defined as \", _jsx(InlineCode, {\n          children: \"cdef class\"\n        }), \" objects. The\\nunderlying data for these objects is usually gathered into a struct, which is\\nusually named \", _jsx(InlineCode, {\n          children: \"c\"\n        }), \". For instance, the \", _jsx(_components.a, {\n          href: \"/api/cython-classses#lexeme\",\n          children: _jsx(InlineCode, {\n            children: \"Lexeme\"\n          })\n        }), \"\\nclass holds a \", _jsx(_components.a, {\n          href: \"/api/cython-structs#lexemec\",\n          children: _jsx(InlineCode, {\n            children: \"LexemeC\"\n          })\n        }), \" struct, at \", _jsx(InlineCode, {\n          children: \"Lexeme.c\"\n        }), \".\\nThis lets you shed the Python container, and pass a pointer to the underlying\\ndata into C-level functions.\"]\n      })]\n    }), \"\\n\", _jsxs(_components.section, {\n      id: \"section-conventions\",\n      children: [_jsx(_components.h2, {\n        id: \"conventions\",\n        children: \"Conventions \"\n      }), _jsxs(_components.p, {\n        children: [\"spaCyâ€™s core data structures are implemented as \", _jsx(_components.a, {\n          href: \"http://cython.org/\",\n          children: \"Cython\"\n        }), \"\\n\", _jsx(InlineCode, {\n          children: \"cdef\"\n        }), \" classes. Memory is managed through the\\n\", _jsx(_components.a, {\n          href: \"https://github.com/explosion/cymem\",\n          children: _jsx(InlineCode, {\n            children: \"cymem\"\n          })\n        }), \" \", _jsx(InlineCode, {\n          children: \"cymem.Pool\"\n        }), \" class, which allows\\nyou to allocate memory which will be freed when the \", _jsx(InlineCode, {\n          children: \"Pool\"\n        }), \" object is garbage\\ncollected. This means you usually donâ€™t have to worry about freeing memory. You\\njust have to decide which Python object owns the memory, and make it own the\\n\", _jsx(InlineCode, {\n          children: \"Pool\"\n        }), \". When that object goes out of scope, the memory will be freed. You do\\nhave to take care that no pointers outlive the object that owns them â€” but this\\nis generally quite easy.\"]\n      }), _jsxs(_components.p, {\n        children: [\"All Cython modules should have the \", _jsx(InlineCode, {\n          children: \"# cython: infer_types=True\"\n        }), \" compiler\\ndirective at the top of the file. This makes the code much cleaner, as it avoids\\nthe need for many type declarations. If possible, you should prefer to declare\\nyour functions \", _jsx(InlineCode, {\n          children: \"nogil\"\n        }), \", even if you donâ€™t especially care about multi-threading.\\nThe reason is that \", _jsx(InlineCode, {\n          children: \"nogil\"\n        }), \" functions help the Cython compiler reason about your\\ncode quite a lot â€” youâ€™re telling the compiler that no Python dynamics are\\npossible. This lets many errors be raised, and ensures your function will run at\\nC speed.\"]\n      }), _jsx(_components.p, {\n        children: \"Cython gives you many choices of sequences: you could have a Python list, a\\nnumpy array, a memory view, a C++ vector, or a pointer. Pointers are preferred,\\nbecause they are fastest, have the most explicit semantics, and let the compiler\\ncheck your code more strictly. C++ vectors are also great â€” but you should only\\nuse them internally in functions. Itâ€™s less friendly to accept a vector as an\\nargument, because that asks the user to do much more work. Hereâ€™s how to get a\\npointer from a numpy array, memory view or vector:\"\n      }), _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-python\",\n          lang: \"python\",\n          children: \"cdef void get_pointers(np.ndarray[int, mode='c'] numpy_array, vector[int] cpp_vector, int[::1] memory_view) nogil:\\npointer1 = \u003cint*\u003enumpy_array.data\\npointer2 = cpp_vector.data()\\npointer3 = \u0026memory_view[0]\\n\"\n        })\n      }), _jsx(_components.p, {\n        children: \"Both C arrays and C++ vectors reassure the compiler that no Python operations\\nare possible on your variable. This is a big advantage: it lets the Cython\\ncompiler raise many more errors for you.\"\n      }), _jsx(_components.p, {\n        children: \"When getting a pointer from a numpy array or memoryview, take care that the data\\nis actually stored in C-contiguous order â€” otherwise youâ€™ll get a pointer to\\nnonsense. The type-declarations in the code above should generate runtime errors\\nif buffers with incorrect memory layouts are passed in. To iterate over the\\narray, the following style is preferred:\"\n      }), _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-python\",\n          lang: \"python\",\n          children: \"cdef int c_total(const int* int_array, int length) nogil:\\n    total = 0\\n    for item in int_array[:length]:\\n        total += item\\n    return total\\n\"\n        })\n      }), _jsxs(_components.p, {\n        children: [\"If this is confusing, consider that the compiler couldnâ€™t deal with\\n\", _jsx(InlineCode, {\n          children: \"for item in int_array:\"\n        }), \" â€” thereâ€™s no length attached to a raw pointer, so how\\ncould we figure out where to stop? The length is provided in the slice notation\\nas a solution to this. Note that we donâ€™t have to declare the type of \", _jsx(InlineCode, {\n          children: \"item\"\n        }), \" in\\nthe code above â€” the compiler can easily infer it. This gives us tidy code that\\nlooks quite like Python, but is exactly as fast as C â€” because weâ€™ve made sure\\nthe compilation to C is trivial.\"]\n      }), _jsxs(_components.p, {\n        children: [\"Your functions cannot be declared \", _jsx(InlineCode, {\n          children: \"nogil\"\n        }), \" if they need to create Python objects\\nor call Python functions. This is perfectly okay â€” you shouldnâ€™t torture your\\ncode just to get \", _jsx(InlineCode, {\n          children: \"nogil\"\n        }), \" functions. However, if your function isnâ€™t \", _jsx(InlineCode, {\n          children: \"nogil\"\n        }), \", you\\nshould compile your module with \", _jsx(InlineCode, {\n          children: \"cython -a --cplus my_module.pyx\"\n        }), \" and open the\\nresulting \", _jsx(InlineCode, {\n          children: \"my_module.html\"\n        }), \" file in a browser. This will let you see how Cython\\nis compiling your code. Calls into the Python run-time will be in bright yellow.\\nThis lets you easily see whether Cython is able to correctly type your code, or\\nwhether there are unexpected problems.\"]\n      }), _jsxs(_components.p, {\n        children: [\"Working in Cython is very rewarding once youâ€™re over the initial learning curve.\\nAs with C and C++, the first way you write something in Cython will often be the\\nperformance-optimal approach. In contrast, Python optimization generally\\nrequires a lot of experimentation. Is it faster to have an \", _jsx(InlineCode, {\n          children: \"if item in my_dict\"\n        }), \"\\ncheck, or to use \", _jsx(InlineCode, {\n          children: \".get()\"\n        }), \"? What about \", _jsx(InlineCode, {\n          children: \"try\"\n        }), \"/\", _jsx(InlineCode, {\n          children: \"except\"\n        }), \"? Does this numpy operation\\ncreate a copy? Thereâ€™s no way to guess the answers to these questions, and\\nyouâ€™ll usually be dissatisfied with your results â€” so thereâ€™s no way to know\\nwhen to stop this process. In the worst case, youâ€™ll make a mess that invites\\nthe next reader to try their luck too. This is like one of those\\n\", _jsx(_components.a, {\n          href: \"http://www.wemjournal.org/article/S1080-6032%2809%2970088-2/abstract\",\n          children: \"volcanic gas-traps\"\n        }), \",\\nwhere the rescuers keep passing out from low oxygen, causing another rescuer to\\nfollow â€” only to succumb themselves. In short, just say no to optimizing your\\nPython. If itâ€™s not fast enough the first time, just switch to Cython.\"]\n      }), _jsx(Infobox, {\n        title: \"Resources\",\n        emoji: \"ðŸ“–\",\n        children: _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.a, {\n              href: \"http://docs.cython.org/en/latest/\",\n              children: \"Official Cython documentation\"\n            }), \"\\n(cython.org)\"]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.a, {\n              href: \"https://explosion.ai/blog/writing-c-in-cython\",\n              children: \"Writing C in Cython\"\n            }), \"\\n(explosion.ai)\"]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.a, {\n              href: \"https://explosion.ai/blog/multithreading-with-cython\",\n              children: \"Multi-threading spaCyâ€™s parser and named entity recognizer\"\n            }), \"\\n(explosion.ai)\"]\n          }), \"\\n\"]\n        })\n      })]\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\nfunction _missingMdxReference(id, component) {\n  throw new Error(\"Expected \" + (component ? \"component\" : \"object\") + \" `\" + id + \"` to be defined: you likely forgot to import, pass, or provide it.\");\n}\n","frontmatter":{"title":"Cython Architecture","next":"/api/cython-structs","menu":[["Overview","overview"],["Conventions","conventions"]]},"scope":{}},"sectionTitle":"API Documentation","theme":"green","section":"api","apiDetails":{"stringName":null,"baseClass":null,"trainable":null},"isIndex":false},"__N_SSG":true},"page":"/[...listPathPage]","query":{"listPathPage":["api","cython"]},"buildId":"2lY2cUyEfZosk4VLgkHb2","isFallback":false,"dynamicIds":[728],"gsp":true,"scriptLoader":[]}</script></body></html>